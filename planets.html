<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>    
<script src="sylvester.js"></script>
    <script src="jquery_mousewheel_plugin.js"></script>
    <title></title>

    <style>
        body {
            background-color: #000;
            color: #eee;
        }

        canvas {
            clear:both;
            float:left;
        }

        div.panel {
            float:left;
        }
    </style>
</head>
<body>

    <div>
        <h2>Planetary workbench</h2>

    <canvas id="spacecanvas" width="500" height="500"></canvas>
        <div class="panel">

            <button id="randomBodyButton">Add random</button>

            <h3>Instructions</h3>
            <p>Use mouse-wheel to zoom.</p>
        </div>
    </div>

<script type="text/javascript">

    var canvasHeight = 500, canvasWidth = 500;
    var zoom = 0.5;
    var canvasLength = 450000 * 1000;
    var pixelMeters = 450000 * 1000 / 900;
    var cG = 6.67384 * 0.00000000001;
    var canvas;
    var ctx;
    var globalTime = 0;
    var timeStep = 1000;

    var bodies = [
        {
            name: 'Earth',
            mass: 5.9736 * 1000000000000000000000000,
            position: $V([0, 0]),
            velocity: $V([-12, 0]),
            strokeStyle: "#7777DD",
            fillStyle: "#7777DD",
        },

        {
            name: 'Moon',
            mass: 7.3477 * 10000000000000000000000,
            position: $V([0, 384399 * 1000]),
            velocity: $V([950,0]),
            strokeStyle: "#888888",
            fillStyle: "#888888"
    },

    {
        name: 'Moon 2',
        mass: 7.3477 * 10000000000000000000000,
        position: $V([0, -384399 * 1000]),
    velocity: $V([-950,0]),
    strokeStyle: "#888888",
    fillStyle: "#888888"
    },

    {
        name: 'Moon 3',
        mass: 7.3477 * 10000000000000000000000,
    position: $V([-384399 * 1000, 0]),
    velocity: $V([0,250]),
    strokeStyle: "#888888",
    fillStyle: "#888888"
    }
    ];

    function updateLocation(actor, t) {
        actor.position = actor.position.add(actor.velocity.multiply(t));
    }

    function updateVelocityByG(puller, actor) {
        // initial momentum
        var p0_ = actor.velocity.multiply(actor.mass);

        var dist = puller.position.distanceFrom(actor.position);

        // Force magnitude
        var F = cG * puller.mass * actor.mass / (dist * dist);

        // Force vector
        var F_ = puller.position.subtract(actor.position).toUnitVector().multiply(F);

        var t = timeStep;
        var p1_ = p0_.add(F_.multiply(t));

//        actor.position = actor.position.add(p1_.multiply(t / actor.mass));
        actor.velocity = p1_.multiply(1 / actor.mass);

        // change of momentum
//        var p_ = F * t; // 1 ms

        // direction of momentum * |p|
        //var p = puller.position.subtract(actor.position).multiply(p_);

        actor.force = F_;


        // final momentum
        //var p1 = p0.multiply(p);

        // update velocity

        /*var newvel = actor.velocity.add(F_.multiply(t / actor.mass));
        actor.velocity = newvel;
        var newpos = actor.position.add(actor.velocity.multiply(t));
        actor.position = newpos;*/
    }

    function mapCoordinates(x, y) {
        return [x * zoom / pixelMeters /** canvasWidth*/ + canvasWidth / 2,

            canvasHeight / 2 - y * zoom / pixelMeters /** canvasHeight*/];
    }

    function draw() {
        // update locations etc.

        var i;
        for (i = 0; i < bodies.length; i++) {
            for (j = i+1; j < bodies.length; j++) {
                if (j != i) {
                    updateVelocityByG(bodies[i], bodies[j]);
                    updateVelocityByG(bodies[j], bodies[i]);
                }
            }
        }
        for (i = 0; i < bodies.length; i++) {
            updateLocation(bodies[i], timeStep);
        }
            //        updateBodyByG(bodies[0], bodies[1]);
//        updateBodyByG(bodies[1], bodies[0]);

        globalTime += timeStep;

        // update velocity

        // draw objects

        ctx.fillStyle = "#111122";
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        //ctx.fillText("vel: " + bodies[1].velocity.distanceFrom(Vector.Zero(2)), 10, 30);
        for (i = 0; i < bodies.length; i++) {
            var body = bodies[i];
            ctx.beginPath();
            ctx.fillStyle = body.fillStyle;
            ctx.strokeStyle = body.strokeStyle;

            var coords = mapCoordinates(body.position.e(1), body.position.e(2));
            var x = coords[0];
            var y = coords[1];

            ctx.arc(x, y,
                10 * zoom, 0, 2 * Math.PI, false);
            ctx.lineWidth = 1;
            ctx.fill();
            ctx.stroke();

            ctx.fillText(body.name, x + 10, y - 10);
            //ctx.fillText("m="+body.mass , x + 10, y );
            //ctx.fillText("v=" + body.velocity.distanceFrom(Vector.Zero(2)), x + 10, y + 10 );
            //ctx.fillText("x: " + body.position.e(1), x+10, y + 20);
            //ctx.fillText("y: " + body.position.e(2), x+10, y + 30);
        }

        //ctx.fillText("time: " + (globalTime / 60 / 60 / 24).toString() + " days", 10, 40);
    }

    $(document).ready(function () {

        var canv = $("#spacecanvas");
        canvas = canv.get(0);
        ctx = canvas.getContext('2d');

        var windowsize = getWindowSize();
        canvasWidth = windowsize.width - 200;
        canvasHeight = windowsize.height - 100;

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        canv.mousewheel(function (ev, delta) {
            zoom += delta * 0.02;
        });

        window.setInterval(draw, 1);
    });

    var getWindowSize = (function () {
        var docEl = document.documentElement,
            IS_BODY_ACTING_ROOT = docEl && docEl.clientHeight === 0;

        // Used to feature test Opera returning wrong values 
        // for documentElement.clientHeight. 
        function isDocumentElementHeightOff() {
            var d = document,
                div = d.createElement('div');
            div.style.height = "2500px";
            d.body.insertBefore(div, d.body.firstChild);
            var r = d.documentElement.clientHeight > 2400;
            d.body.removeChild(div);
            return r;
        }

        if (typeof document.clientWidth == "number") {
            return function () {
                return { width: document.clientWidth, height: document.clientHeight };
            };
        } else if (IS_BODY_ACTING_ROOT || isDocumentElementHeightOff()) {
            var b = document.body;
            return function () {
                return { width: b.clientWidth, height: b.clientHeight };
            };
        } else {
            return function () {
                return { width: docEl.clientWidth, height: docEl.clientHeight };
            };
        }
    })();


</script>

</body>
</html>